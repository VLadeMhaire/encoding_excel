<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAT Encoding Data Repository</title>
    <!-- Import Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto+Mono:wght@300;400&display=swap" rel="stylesheet">
    <style>
        /* ============================================
           VAT ENCODER SYSTEM - MODERN STYLE
           Blue/Red Color Combination from index.php
           ============================================ */

        /* CSS Variables for consistent theming - Blue/Red Theme */
        :root {
            /* Blue Palette from index.php */
            --blue-primary: #2196f3;
            --blue-dark: #0d47a1;
            --blue-darkest: #1a237e;
            --blue-light: rgba(33, 150, 243, 0.1);
            --blue-medium: rgba(33, 150, 243, 0.3);
            
            /* Red Palette from index.php */
            --red-primary: #f44336;
            --red-dark: #b71c1c;
            --red-darkest: #bf360c;
            --red-light: rgba(244, 67, 54, 0.1);
            --red-medium: rgba(244, 67, 54, 0.3);
            
            /* Gradient combinations */
            --gradient-blue-red: linear-gradient(135deg, var(--blue-darkest) 0%, var(--blue-dark) 50%, var(--red-dark) 100%);
            --gradient-blue: linear-gradient(135deg, var(--blue-primary) 0%, var(--blue-dark) 100%);
            --gradient-red: linear-gradient(135deg, var(--red-primary) 0%, var(--red-dark) 100%);
            
            /* Neutral Colors */
            --white: #ffffff;
            --gray-lightest: #f8f9fa;
            --gray-lighter: #e9ecef;
            --gray-light: #dee2e6;
            --gray-medium: #adb5bd;
            --gray-dark: #6c757d;
            --gray-darker: #495057;
            --gray-darkest: #212529;
            --black: #000000;
            
            /* Semantic Colors matching index.php */
            --primary: var(--blue-primary);
            --primary-light: var(--blue-light);
            --secondary: var(--red-primary);
            --secondary-light: var(--red-light);
            --success: #4caf50;
            --success-dark: #2e7d32;
            --warning: #ffc107;
            --warning-dark: #ff9800;
            --danger: var(--red-primary);
            --danger-dark: var(--red-dark);
            --info: #17a2b8;
            --info-dark: #138496;
            --vat-color: #ff9800;
            --vat-dark: #e65100;
            
            /* Category colors from index.php */
            --info-card: linear-gradient(135deg, rgba(33,150,243,0.3) 0%, rgba(13,71,161,0.3) 100%);
            --sales-card: linear-gradient(135deg, rgba(76,175,80,0.3) 0%, rgba(46,125,50,0.3) 100%);
            --purchases-card: linear-gradient(135deg, rgba(255,152,0,0.3) 0%, rgba(230,81,0,0.3) 100%);
            --expenses-card: linear-gradient(135deg, rgba(156,39,176,0.3) 0%, rgba(123,31,162,0.3) 100%);
            --taxes-card: linear-gradient(135deg, rgba(244,67,54,0.3) 0%, rgba(183,28,28,0.3) 100%);
            --vat-card: linear-gradient(135deg, rgba(255,193,7,0.3) 0%, rgba(255,152,0,0.3) 100%);
            
            /* Typography */
            --font-primary: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --font-mono: 'Roboto Mono', 'Courier New', monospace;
            --font-size-xs: 0.75rem;   /* 12px */
            --font-size-sm: 0.875rem;  /* 14px */
            --font-size-base: 1rem;    /* 16px */
            --font-size-lg: 1.125rem;  /* 18px */
            --font-size-xl: 1.25rem;   /* 20px */
            --font-size-2xl: 1.5rem;   /* 24px */
            --font-size-3xl: 1.875rem; /* 30px */
            
            /* Spacing */
            --spacing-xs: 0.25rem;  /* 4px */
            --spacing-sm: 0.5rem;   /* 8px */
            --spacing-md: 1rem;     /* 16px */
            --spacing-lg: 1.5rem;   /* 24px */
            --spacing-xl: 2rem;     /* 32px */
            --spacing-2xl: 3rem;    /* 48px */
            
            /* Border Radius */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-2xl: 20px;
            
            /* Shadows */
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.2);
            --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.2);
            
            /* Transitions */
            --transition-fast: 150ms ease-in-out;
            --transition-normal: 300ms ease-in-out;
            --transition-slow: 350ms ease-in-out;
        }

        /* Reset & Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-primary);
            font-size: var(--font-size-base);
            line-height: 1.6;
            color: var(--white);
            background: var(--gradient-blue-red);
            min-height: 100vh;
        }

        .container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--spacing-md);
            gap: var(--spacing-lg);
        }

        /* Header/Navbar */
        header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-xl);
            padding: var(--spacing-lg);
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.2);
            margin-bottom: var(--spacing-lg);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }

        h1 {
            font-size: var(--font-size-2xl);
            color: var(--white);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: var(--spacing-sm);
        }

        .subtitle {
            font-size: var(--font-size-sm);
            opacity: 0.9;
            color: var(--white);
        }

        .subtitle a {
            color: var(--blue-primary);
            text-decoration: none;
            transition: color var(--transition-fast);
        }

        .subtitle a:hover {
            color: var(--white);
            text-decoration: underline;
        }

        /* Data Sections */
        .data-section {
            background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.05) 100%);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            margin-bottom: var(--spacing-lg);
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(5px);
        }

        .section-header {
            background: linear-gradient(135deg, var(--blue-medium) 0%, var(--blue-light) 100%);
            color: var(--white);
            padding: var(--spacing-md) var(--spacing-lg);
            font-size: var(--font-size-lg);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .section-content {
            padding: var(--spacing-lg);
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
            overflow: hidden;
            backdrop-filter: blur(5px);
            min-width: 600px;
        }

        table th,
        table td {
            padding: var(--spacing-sm) var(--spacing-md);
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--white);
            font-size: var(--font-size-sm);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }

        table th {
            background: linear-gradient(135deg, var(--blue-medium) 0%, var(--blue-light) 100%);
            font-weight: 600;
            text-transform: uppercase;
            font-size: var(--font-size-xs);
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--blue-primary);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        table td {
            background: transparent;
            transition: background-color var(--transition-fast);
            cursor: text;
            position: relative;
        }

        table td:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        table td[contenteditable="true"]:focus {
            outline: 2px solid var(--blue-primary);
            outline-offset: -1px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: var(--radius-sm);
        }

        /* Editable cell specific styles */
        table td.editing {
            background: rgba(255, 255, 255, 0.2) !important;
            box-shadow: inset 0 0 0 2px var(--blue-primary);
            border-radius: var(--radius-sm);
        }

        /* Ensure text fits perfectly in cells */
        table td:not(:first-child) {
            min-width: 120px;
        }

        table td:first-child {
            min-width: 150px;
        }

        /* Currency and date cells */
        table td.currency {
            font-family: var(--font-mono);
            text-align: right;
            min-width: 140px;
        }

        table td.date {
            font-family: var(--font-mono);
            min-width: 130px;
        }

        table td.tin {
            font-family: var(--font-mono);
            min-width: 160px;
        }

        .no-data {
            text-align: center;
            padding: var(--spacing-xl);
            color: rgba(255, 255, 255, 0.7);
            font-style: italic;
            font-size: var(--font-size-lg);
        }

        .last-updated {
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            font-size: var(--font-size-sm);
            margin-top: var(--spacing-lg);
            padding-top: var(--spacing-md);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
        }

        /* Buttons */
        .refresh-btn {
            background: linear-gradient(135deg, var(--blue-primary) 0%, var(--blue-dark) 100%);
            color: var(--white);
            border: none;
            padding: var(--spacing-sm) var(--spacing-xl);
            border-radius: var(--radius-2xl);
            cursor: pointer;
            font-size: var(--font-size-base);
            font-weight: 600;
            transition: all var(--transition-normal);
            box-shadow: var(--shadow-sm);
            min-width: 140px;
        }

        .refresh-btn:hover {
            background: linear-gradient(135deg, var(--blue-dark) 0%, var(--blue-darkest) 100%);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .refresh-btn:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }

        /* Save button for editable content */
        .save-btn {
            background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
            color: var(--white);
            border: none;
            padding: var(--spacing-sm) var(--spacing-xl);
            border-radius: var(--radius-2xl);
            cursor: pointer;
            font-size: var(--font-size-base);
            font-weight: 600;
            transition: all var(--transition-normal);
            box-shadow: var(--shadow-sm);
            min-width: 140px;
            margin-left: var(--spacing-sm);
        }

        .save-btn:hover {
            background: linear-gradient(135deg, var(--success-dark) 0%, #1b5e20 100%);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .save-btn:disabled {
            background: var(--gray-dark);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .loading {
            text-align: center;
            padding: var(--spacing-2xl);
            color: rgba(255, 255, 255, 0.8);
            font-size: var(--font-size-lg);
            background: rgba(0, 0, 0, 0.3);
            border-radius: var(--radius-xl);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .error {
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.2) 0%, rgba(183, 28, 28, 0.1) 100%);
            color: var(--red-primary);
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            margin: var(--spacing-lg) 0;
            border: 1px solid rgba(244, 67, 54, 0.3);
            backdrop-filter: blur(5px);
        }

        .error h3 {
            color: var(--red-primary);
            margin-bottom: var(--spacing-md);
        }

        .error ol {
            margin-left: var(--spacing-lg);
            margin-top: var(--spacing-md);
        }

        .error li {
            margin-bottom: var(--spacing-xs);
        }

        /* Save status message */
        .save-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-lg);
            font-weight: 600;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
            animation: slideInRight 0.3s ease-out;
            backdrop-filter: blur(10px);
        }

        .save-status.success {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.9) 0%, rgba(46, 125, 50, 0.9) 100%);
            color: var(--white);
            border: 1px solid rgba(76, 175, 80, 0.5);
        }

        .save-status.error {
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.9) 0%, rgba(183, 28, 28, 0.9) 100%);
            color: var(--white);
            border: 1px solid rgba(244, 67, 54, 0.5);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--blue-primary), var(--red-primary));
            border-radius: var(--radius-md);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--blue-dark), var(--red-dark));
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: var(--spacing-sm);
            }
            
            header {
                padding: var(--spacing-md);
            }
            
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: var(--spacing-md);
            }
            
            .refresh-btn,
            .save-btn {
                width: 100%;
                max-width: 300px;
                margin: var(--spacing-xs) 0;
            }
            
            .section-content {
                padding: var(--spacing-md);
            }
            
            table th,
            table td {
                padding: var(--spacing-xs) var(--spacing-sm);
                font-size: var(--font-size-xs);
            }
            
            table td:not(:first-child) {
                min-width: 100px;
            }
            
            table td:first-child {
                min-width: 120px;
            }
            
            .save-status {
                top: 10px;
                right: 10px;
                left: 10px;
                text-align: center;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: var(--font-size-xl);
            }
            
            .section-header {
                font-size: var(--font-size-base);
                padding: var(--spacing-sm);
            }
            
            .no-data {
                padding: var(--spacing-lg);
                font-size: var(--font-size-base);
            }
            
            table {
                min-width: 500px;
            }
        }

        /* Animation for loading */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .data-section {
            animation: fadeIn 0.3s ease-out forwards;
            opacity: 0;
        }

        .data-section:nth-child(1) { animation-delay: 0.1s; }
        .data-section:nth-child(2) { animation-delay: 0.15s; }
        .data-section:nth-child(3) { animation-delay: 0.2s; }
        .data-section:nth-child(4) { animation-delay: 0.25s; }
        .data-section:nth-child(5) { animation-delay: 0.3s; }
        .data-section:nth-child(6) { animation-delay: 0.35s; }
        .data-section:nth-child(7) { animation-delay: 0.4s; }
        .data-section:nth-child(8) { animation-delay: 0.45s; }
        .data-section:nth-child(9) { animation-delay: 0.5s; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div>
                    <h1>VAT Encoding Data Repository</h1>
                    <p class="subtitle">Automatically synced data from PHP Desktop Encoder</p>
                    <p class="subtitle">Repository: <a href="https://github.com/vlademhaire/encoding_excel">github.com/vlademhaire/encoding_excel</a></p>
                </div>
                <div>
                    <button class="refresh-btn" onclick="loadData()">ðŸ”„ Refresh Data</button>
                    <button class="save-btn" onclick="saveAllChanges()" id="save-all-btn" disabled>ðŸ’¾ Save All Changes</button>
                </div>
            </div>
        </header>
        
        <div class="loading" id="loading">ðŸ“Š Loading data from GitHub repository...</div>
        <div id="error-container" style="display: none;"></div>
        
        <div id="data-container" style="display: none;">
            <div class="data-section">
                <div class="section-header">Vatable Sales</div>
                <div class="section-content" id="vatable-sales">
                    <div class="no-data">No data available</div>
                </div>
            </div>
            
            <div class="data-section">
                <div class="section-header">Non-VAT Sales</div>
                <div class="section-content" id="non-vat-sales">
                    <div class="no-data">No data available</div>
                </div>
            </div>
            
            <div class="data-section">
                <div class="section-header">Vatable Purchases</div>
                <div class="section-content" id="vatable-purchases">
                    <div class="no-data">No data available</div>
                </div>
            </div>
            
            <div class="data-section">
                <div class="section-header">Non-VAT Purchases</div>
                <div class="section-content" id="non-vat-purchases">
                    <div class="no-data">No data available</div>
                </div>
            </div>
            
            <div class="data-section">
                <div class="section-header">Vatable Expenses</div>
                <div class="section-content" id="vatable-expenses">
                    <div class="no-data">No data available</div>
                </div>
            </div>
            
            <div class="data-section">
                <div class="section-header">Non-VAT Expenses</div>
                <div class="section-content" id="non-vat-expenses">
                    <div class="no-data">No data available</div>
                </div>
            </div>
            
            <div class="data-section">
                <div class="section-header">Capex</div>
                <div class="section-content" id="capex">
                    <div class="no-data">No data available</div>
                </div>
            </div>
            
            <div class="data-section">
                <div class="section-header">Taxes & Licenses</div>
                <div class="section-content" id="taxes-licenses">
                    <div class="no-data">No data available</div>
                </div>
            </div>
            
            <div class="data-section">
                <div class="section-header">Purchase Returns</div>
                <div class="section-content" id="purchase-returns">
                    <div class="no-data">No data available</div>
                </div>
            </div>
            
            <div class="last-updated" id="last-updated">
                Last updated: Loading...
            </div>
        </div>
    </div>

    <script>
    // GitHub repository details
    const REPO_OWNER = 'vlademhaire';
    const REPO_NAME = 'encoding_excel';
    const DATA_FILE = 'data.json';
    
    // GitHub Pages URL for the data file
    const DATA_URL = `https://${REPO_OWNER}.github.io/${REPO_NAME}/${DATA_FILE}`;
    // Alternative: Raw GitHub URL (works better for JSON)
    const RAW_DATA_URL = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/${DATA_FILE}`;
    
    // Store original data and changes
    let originalData = [];
    let currentData = [];
    let changesMade = false;
    let cellEditHistory = [];
    
    function formatCurrency(amount) {
        if (typeof amount !== 'number') {
            amount = parseFloat(amount) || 0;
        }
        return 'â‚±' + amount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
    }
    
    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        } catch (e) {
            return dateString;
        }
    }
    
    function formatTIN(tin) {
        if (!tin) return 'N/A';
        if (tin.length === 12) {
            return tin.substring(0, 3) + '-' + tin.substring(3, 6) + '-' +
                   tin.substring(6, 9) + '-' + tin.substring(9, 12);
        }
        if (tin.length === 14 && tin.includes('-')) {
            return tin; // Already formatted
        }
        return tin;
    }
    
    function parseCurrencyValue(value) {
        if (typeof value === 'string') {
            // Remove currency symbol and commas
            const cleaned = value.replace(/[â‚±,]/g, '').trim();
            return parseFloat(cleaned) || 0;
        }
        return parseFloat(value) || 0;
    }
    
    function showSaveStatus(message, type = 'success') {
        // Remove existing status
        const existingStatus = document.querySelector('.save-status');
        if (existingStatus) {
            existingStatus.remove();
        }
        
        // Create new status
        const status = document.createElement('div');
        status.className = `save-status ${type}`;
        status.textContent = message;
        document.body.appendChild(status);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
            if (status.parentNode) {
                status.style.opacity = '0';
                status.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (status.parentNode) {
                        status.remove();
                    }
                }, 300);
            }
        }, 3000);
    }
    
    function updateSaveButton() {
        const saveBtn = document.getElementById('save-all-btn');
        if (changesMade) {
            saveBtn.disabled = false;
            saveBtn.title = `Changes made: ${cellEditHistory.length} cell(s)`;
        } else {
            saveBtn.disabled = true;
            saveBtn.title = 'No changes to save';
        }
    }
    
    function renderTable(data, containerId, formType) {
        const container = document.getElementById(containerId);
        
        if (!data || data.length === 0) {
            container.innerHTML = '<div class="no-data">No data available</div>';
            return;
        }
        
        // Filter by form type
        const filteredData = data.filter(entry => 
            entry.form_type === formType || 
            entry.form_type === formType.replace('-', '_')
        );
        
        if (filteredData.length === 0) {
            container.innerHTML = '<div class="no-data">No data available</div>';
            return;
        }
        
        // Get headers from first data item
        const firstItem = filteredData[0].data || {};
        const headers = Object.keys(firstItem);
        
        let html = '<table>';
        
        // Table header
        html += '<thead><tr>';
        headers.forEach(header => {
            const displayName = header.replace(/_/g, ' ').toUpperCase();
            html += `<th>${displayName}</th>`;
        });
        html += '</tr></thead>';
        
        // Table body
        html += '<tbody>';
        filteredData.forEach((item, rowIndex) => {
            const itemData = item.data || {};
            html += '<tr>';
            headers.forEach(header => {
                let value = itemData[header];
                let cellClass = '';
                let isCurrency = false;
                let isDate = false;
                let isTIN = false;
                
                // Determine cell type
                if (header.includes('date')) {
                    cellClass = 'date';
                    isDate = true;
                    value = formatDate(value);
                } else if (header.includes('tin')) {
                    cellClass = 'tin';
                    isTIN = true;
                    value = formatTIN(value);
                } else if (typeof value === 'number' || 
                          (typeof value === 'string' && !isNaN(value) && value.trim() !== '')) {
                    const numValue = parseFloat(value);
                    if (!isNaN(numValue) && 
                        (header.includes('amount') || header.includes('sales') || 
                         header.includes('purchases') || header.includes('expenses') || 
                         header.includes('tax') || header.includes('gross') || 
                         header.includes('net') || header.includes('value') ||
                         header.includes('cost') || header.includes('price'))) {
                        cellClass = 'currency';
                        isCurrency = true;
                        value = formatCurrency(numValue);
                    } else if (header.includes('rate') && !isNaN(numValue)) {
                        value = numValue + '%';
                    }
                }
                
                // Store raw value in data attributes
                const rawValue = itemData[header] || '';
                html += `<td class="${cellClass}" 
                            contenteditable="true" 
                            data-original="${rawValue}"
                            data-header="${header}"
                            data-row="${rowIndex}"
                            data-form="${formType}"
                            data-currency="${isCurrency}"
                            data-date="${isDate}"
                            data-tin="${isTIN}">${value !== undefined && value !== null ? value : 'N/A'}</td>`;
            });
            html += '</tr>';
        });
        html += '</tbody></table>';
        
        container.innerHTML = html;
        
        // Add event listeners for editable cells
        const cells = container.querySelectorAll('td[contenteditable="true"]');
        cells.forEach(cell => {
            cell.addEventListener('focus', handleCellFocus);
            cell.addEventListener('blur', handleCellBlur);
            cell.addEventListener('input', handleCellInput);
            cell.addEventListener('keydown', handleCellKeydown);
        });
    }
    
    function handleCellFocus(e) {
        const cell = e.target;
        cell.classList.add('editing');
        
        // Store original value for comparison
        cell.dataset.currentValue = cell.textContent;
    }
    
    function handleCellBlur(e) {
        const cell = e.target;
        cell.classList.remove('editing');
        
        const originalValue = cell.dataset.original || '';
        const currentValue = cell.textContent;
        const header = cell.dataset.header;
        const row = parseInt(cell.dataset.row);
        const formType = cell.dataset.form;
        const isCurrency = cell.dataset.currency === 'true';
        const isDate = cell.dataset.date === 'true';
        const isTIN = cell.dataset.tin === 'true';
        
        // Format the value based on type
        let displayValue = currentValue;
        if (isCurrency && currentValue !== 'N/A') {
            const numValue = parseCurrencyValue(currentValue);
            displayValue = formatCurrency(numValue);
            cell.textContent = displayValue;
        } else if (isDate && currentValue !== 'N/A') {
            displayValue = formatDate(currentValue);
            cell.textContent = displayValue;
        } else if (isTIN && currentValue !== 'N/A') {
            displayValue = formatTIN(currentValue);
            cell.textContent = displayValue;
        }
        
        // Check if value changed
        if (originalValue !== currentValue && currentValue !== cell.dataset.currentValue) {
            // Store change
            const changeId = `${formType}-${row}-${header}`;
            const existingChangeIndex = cellEditHistory.findIndex(change => change.id === changeId);
            
            if (existingChangeIndex >= 0) {
                // Update existing change
                cellEditHistory[existingChangeIndex].newValue = currentValue;
                cellEditHistory[existingChangeIndex].displayValue = displayValue;
            } else {
                // Add new change
                cellEditHistory.push({
                    id: changeId,
                    formType: formType,
                    row: row,
                    header: header,
                    originalValue: originalValue,
                    newValue: currentValue,
                    displayValue: displayValue,
                    isCurrency: isCurrency,
                    isDate: isDate,
                    isTIN: isTIN
                });
            }
            
            changesMade = true;
            updateSaveButton();
            
            // Update cell's original value for future comparisons
            cell.dataset.original = currentValue;
        }
    }
    
    function handleCellInput(e) {
        // You can add live validation here if needed
    }
    
    function handleCellKeydown(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            e.target.blur();
        }
    }
    
    async function saveAllChanges() {
        if (!changesMade || cellEditHistory.length === 0) {
            showSaveStatus('No changes to save', 'error');
            return;
        }
        
        const saveBtn = document.getElementById('save-all-btn');
        saveBtn.disabled = true;
        saveBtn.textContent = 'ðŸ’¾ Saving...';
        
        try {
            // Apply changes to currentData
            cellEditHistory.forEach(change => {
                // Find the data item
                const dataIndex = currentData.findIndex(item => 
                    (item.form_type === change.formType || 
                     item.form_type === change.formType.replace('-', '_')) &&
                    // This is a simplified matching - you might need more robust logic
                    currentData.indexOf(item) === change.row
                );
                
                if (dataIndex >= 0 && currentData[dataIndex].data) {
                    // Update the data
                    currentData[dataIndex].data[change.header] = change.newValue;
                }
            });
            
            // In a real application, you would send the updated data back to your server
            // For now, we'll just show a success message and clear changes
            showSaveStatus(`Successfully saved ${cellEditHistory.length} changes!`);
            
            // Clear changes
            cellEditHistory = [];
            changesMade = false;
            updateSaveButton();
            
            // Update the display
            renderAllTables();
            
        } catch (error) {
            console.error('Error saving changes:', error);
            showSaveStatus('Error saving changes: ' + error.message, 'error');
        } finally {
            saveBtn.textContent = 'ðŸ’¾ Save All Changes';
        }
    }
    
    function renderAllTables() {
        renderTable(currentData, 'vatable-sales', 'vatable_sales');
        renderTable(currentData, 'non-vat-sales', 'non_vat_sales');
        renderTable(currentData, 'vatable-purchases', 'vatable_purchases');
        renderTable(currentData, 'non-vat-purchases', 'non_vat_purchases');
        renderTable(currentData, 'vatable-expenses', 'vatable_expenses');
        renderTable(currentData, 'non-vat-expenses', 'non_vat_expenses');
        renderTable(currentData, 'capex', 'capex');
        renderTable(currentData, 'taxes-licenses', 'taxes_licenses');
        renderTable(currentData, 'purchase-returns', 'purchase_returns');
    }
    
    async function loadData() {
        const loadingEl = document.getElementById('loading');
        const errorContainer = document.getElementById('error-container');
        const dataContainer = document.getElementById('data-container');
        
        loadingEl.style.display = 'block';
        errorContainer.style.display = 'none';
        dataContainer.style.display = 'none';
        errorContainer.innerHTML = '';
        
        // Clear any pending changes
        if (changesMade) {
            if (!confirm('You have unsaved changes. Are you sure you want to reload?')) {
                return;
            }
            cellEditHistory = [];
            changesMade = false;
            updateSaveButton();
        }
        
        try {
            // Try raw.githubcontent first (more reliable for JSON)
            const response = await fetch(RAW_DATA_URL, {
                headers: {
                    'Accept': 'application/json'
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            
            const data = await response.json();
            
            // Store data
            originalData = JSON.parse(JSON.stringify(data));
            currentData = JSON.parse(JSON.stringify(data));
            
            // Hide loading, show data
            loadingEl.style.display = 'none';
            dataContainer.style.display = 'block';
            
            // Render all tables
            renderAllTables();
            
            // Update last updated timestamp
            document.getElementById('last-updated').textContent = 
                'Last updated: ' + new Date().toLocaleString() + 
                ` | Total entries: ${data.length} | Cells are editable - click to edit`;
            
        } catch (error) {
            console.error('Error loading data:', error);
            loadingEl.style.display = 'none';
            errorContainer.style.display = 'block';
            errorContainer.innerHTML = `
                <div class="error">
                    <h3>Error Loading Data</h3>
                    <p>${error.message}</p>
                    <p>Please ensure:</p>
                    <ol>
                        <li><code>data.json</code> exists in your GitHub repository</li>
                        <li>GitHub Pages is enabled for your repository</li>
                        <li>The file is accessible at: <a href="${RAW_DATA_URL}" target="_blank">${RAW_DATA_URL}</a></li>
                    </ol>
                    <p><button onclick="loadData()" class="refresh-btn">Try Again</button></p>
                </div>
            `;
        }
    }
    
    // Load data on page load
    document.addEventListener('DOMContentLoaded', loadData);
    
    // Auto-refresh every 5 minutes (with warning if there are changes)
    setInterval(() => {
        if (!changesMade) {
            loadData();
        }
    }, 300000);
    
    // Warn user before leaving page if there are unsaved changes
    window.addEventListener('beforeunload', (e) => {
        if (changesMade) {
            e.preventDefault();
            e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
            return e.returnValue;
        }
    });
    </script>
</body>
</html>
