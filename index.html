<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAT Encoder - Online Data Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f0f0;
            color: #333;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .header-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-top: 1rem;
        }

        .search-box {
            padding: 0.5rem 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 300px;
            font-size: 0.9rem;
        }

        .date-filter {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .export-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .export-btn:hover {
            background: #219653;
        }

        .container {
            padding: 1.5rem;
            max-width: 100%;
            overflow-x: auto;
        }

        .sheet-tabs {
            display: flex;
            background: #34495e;
            overflow-x: auto;
            scrollbar-width: thin;
        }

        .sheet-tab {
            padding: 1rem 1.5rem;
            background: #34495e;
            color: white;
            border: none;
            border-right: 1px solid #2c3e50;
            cursor: pointer;
            white-space: nowrap;
            font-size: 0.9rem;
        }

        .sheet-tab.active {
            background: #1abc9c;
            font-weight: bold;
        }

        .sheet-tab:hover {
            background: #2c3e50;
        }

        .excel-grid {
            background: white;
            border: 1px solid #ddd;
            overflow: auto;
            height: calc(100vh - 200px);
            position: relative;
        }

        .grid-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #f8f9fa;
            display: grid;
            grid-template-columns: 60px repeat(auto-fit, minmax(150px, 1fr));
            border-bottom: 2px solid #dee2e6;
        }

        .header-cell {
            padding: 0.75rem;
            border-right: 1px solid #dee2e6;
            font-weight: bold;
            color: #495057;
            background: #f8f9fa;
            text-align: left;
            position: sticky;
            top: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .grid-body {
            display: flex;
            flex-direction: column;
        }

        .grid-row {
            display: grid;
            grid-template-columns: 60px repeat(auto-fit, minmax(150px, 1fr));
            border-bottom: 1px solid #dee2e6;
            min-height: 45px;
            align-items: stretch;
        }

        .grid-row:hover {
            background: #f8f9fa;
        }

        .row-number {
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #6c757d;
            border-right: 1px solid #dee2e6;
            position: sticky;
            left: 0;
            z-index: 5;
        }

        .grid-cell {
            padding: 0.75rem;
            border-right: 1px solid #dee2e6;
            display: flex;
            align-items: center;
            min-width: 150px;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .grid-cell.editable {
            background: #fff3cd;
        }

        .grid-cell.calculated {
            background: #d1ecf1;
            font-weight: bold;
        }

        .grid-cell.currency {
            text-align: right;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .grid-cell.date {
            font-family: 'Courier New', monospace;
            color: #0066cc;
        }

        .grid-cell.center {
            text-align: center;
        }

        .data-section {
            margin-bottom: 2rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }

        .section-header {
            background: #3498db;
            color: white;
            padding: 1rem;
            font-size: 1.2rem;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-count {
            background: white;
            color: #3498db;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .form-preview {
            background: #f8f9fa;
            padding: 1rem;
            margin: 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: none;
        }

        .form-preview.active {
            display: block;
        }

        .totals-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #2c3e50;
            color: white;
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            z-index: 100;
        }

        .total-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .total-value {
            font-weight: bold;
            color: #1abc9c;
            font-size: 1.1rem;
        }

        .no-data {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
            font-style: italic;
        }

        .data-controls {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
            padding: 1rem;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .control-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .control-btn:hover {
            background: #f8f9fa;
        }

        .control-btn.delete {
            color: #e74c3c;
            border-color: #e74c3c;
        }

        .control-btn.delete:hover {
            background: #fadbd8;
        }

        .filter-tags {
            display: flex;
            gap: 0.5rem;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .filter-tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-tag .remove {
            cursor: pointer;
            font-weight: bold;
        }

        @media print {
            .header-controls,
            .sheet-tabs,
            .control-btn,
            .filter-tags,
            .totals-bar {
                display: none !important;
            }
            
            .excel-grid {
                height: auto;
                overflow: visible;
            }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìä VAT Encoder - Online Data Viewer</h1>
        <p>Real-time data display from all VAT forms (Excel-like interface)</p>
        
        <div class="header-controls">
            <input type="text" class="search-box" placeholder="üîç Search across all data..." id="globalSearch">
            <input type="date" class="date-filter" id="dateFrom">
            <input type="date" class="date-filter" id="dateTo">
            <select class="date-filter" id="formTypeFilter">
                <option value="">All Forms</option>
                <option value="vatable_sales">Vatable Sales</option>
                <option value="non_vat_sales">Non-VAT Sales</option>
                <option value="vatable_purchases">Vatable Purchases</option>
                <option value="non_vat_purchases">Non-VAT Purchases</option>
                <option value="vatable_expenses">Vatable Expenses</option>
                <option value="non_vat_expenses">Non-VAT Expenses</option>
                <option value="capex">CAPEX</option>
                <option value="taxes_licenses">Taxes & Licenses</option>
                <option value="purchase_returns">Purchase Returns</option>
            </select>
            <button class="export-btn" onclick="exportToCSV()">üì• Export CSV</button>
            <button class="export-btn" onclick="exportToExcel()">üìä Export Excel</button>
            <button class="export-btn" onclick="printView()">üñ®Ô∏è Print</button>
        </div>
    </div>

    <div class="sheet-tabs" id="sheetTabs">
        <!-- Tabs will be generated dynamically -->
    </div>

    <div class="container">
        <div class="filter-tags" id="activeFilters"></div>
        
        <div class="data-controls">
            <button class="control-btn" onclick="refreshData()">üîÑ Refresh Data</button>
            <button class="control-btn" onclick="clearFilters()">üóëÔ∏è Clear Filters</button>
            <button class="control-btn delete" onclick="deleteSelected()">üóëÔ∏è Delete Selected</button>
            <div style="flex-grow: 1;"></div>
            <span id="totalRecords">0 records</span>
        </div>

        <div class="excel-grid" id="excelGrid">
            <!-- Data will be loaded here -->
            <div class="no-data" id="noDataMessage">
                üìÅ No data available. Start adding data from the VAT Encoder app.
            </div>
        </div>
    </div>

    <div class="totals-bar">
        <div class="total-item">
            <span>Total Records:</span>
            <span class="total-value" id="totalRecordsCount">0</span>
        </div>
        <div class="total-item">
            <span>Total Amount:</span>
            <span class="total-value" id="totalAmount">‚Ç±0.00</span>
        </div>
        <div class="total-item">
            <span>Total VAT:</span>
            <span class="total-value" id="totalVAT">‚Ç±0.00</span>
        </div>
        <div class="total-item">
            <span>Total Withholding:</span>
            <span class="total-value" id="totalWithholding">‚Ç±0.00</span>
        </div>
        <div class="total-item">
            <span>Last Updated:</span>
            <span class="total-value" id="lastUpdated">Never</span>
        </div>
    </div>

    <script>
        // Data storage and configuration
        const API_BASE_URL = 'http://localhost/vat-encoder'; // Change to your server URL
        const DATA_FILE = 'data/submissions.json';
        let allData = [];
        let filteredData = [];
        let currentView = 'all';
        let columnDefinitions = {};
        let selectedRows = new Set();

        // Column definitions for each form type
        const formColumns = {
            vatable_sales: [
                { field: 'date', header: 'Date', type: 'date', width: 120 },
                { field: 'invoice_number', header: 'Invoice No.', type: 'text', width: 150 },
                { field: 'invoice_type', header: 'Invoice Type', type: 'text', width: 120 },
                { field: 'mode_of_payment', header: 'Payment Mode', type: 'text', width: 120 },
                { field: 'particulars', header: 'Customer Name', type: 'text', width: 200 },
                { field: 'address', header: 'Address', type: 'text', width: 200 },
                { field: 'tin', header: 'TIN', type: 'text', width: 150 },
                { field: 'gross_sales', header: 'Gross Sales', type: 'currency', width: 150 },
                { field: 'exempt_sales', header: 'Exempt Sales', type: 'currency', width: 150 },
                { field: 'sales_type', header: 'Sales Type', type: 'text', width: 120 },
                { field: 'net_sales', header: 'Net Sales', type: 'currency', width: 150, calculated: true },
                { field: 'output_tax', header: 'Output Tax', type: 'currency', width: 150, calculated: true },
                { field: 'withholding_tax_rate', header: 'WHT Rate', type: 'percentage', width: 100 },
                { field: 'withholding_amount', header: 'WHT Amount', type: 'currency', width: 150, calculated: true },
                { field: 'remarks', header: 'Remarks', type: 'text', width: 250 }
            ],
            non_vat_sales: [
                { field: 'date', header: 'Date', type: 'date', width: 120 },
                { field: 'invoice_number', header: 'Invoice No.', type: 'text', width: 150 },
                { field: 'invoice_type', header: 'Invoice Type', type: 'text', width: 120 },
                { field: 'mode_of_payment', header: 'Payment Mode', type: 'text', width: 120 },
                { field: 'particulars', header: 'Customer Name', type: 'text', width: 200 },
                { field: 'address', header: 'Address', type: 'text', width: 200 },
                { field: 'tin', header: 'TIN', type: 'text', width: 150 },
                { field: 'gross_amount', header: 'Gross Amount', type: 'currency', width: 150 },
                { field: 'sales_type', header: 'Sales Type', type: 'text', width: 120 },
                { field: 'withholding_tax_rate', header: 'WHT Rate', type: 'percentage', width: 100 },
                { field: 'withholding_amount', header: 'WHT Amount', type: 'currency', width: 150, calculated: true },
                { field: 'remarks', header: 'Remarks', type: 'text', width: 250 }
            ],
            vatable_purchases: [
                { field: 'date', header: 'Date', type: 'date', width: 120 },
                { field: 'invoice_number', header: 'Invoice No.', type: 'text', width: 150 },
                { field: 'invoice_type', header: 'Invoice Type', type: 'text', width: 150 },
                { field: 'mode_of_payment', header: 'Payment Mode', type: 'text', width: 120 },
                { field: 'particulars', header: 'Supplier Name', type: 'text', width: 200 },
                { field: 'address', header: 'Address', type: 'text', width: 200 },
                { field: 'tin', header: 'TIN', type: 'text', width: 150 },
                { field: 'gross_purchases', header: 'Gross Purchases', type: 'currency', width: 150 },
                { field: 'net_purchases', header: 'Net Purchases', type: 'currency', width: 150, calculated: true },
                { field: 'input_tax', header: 'Input Tax', type: 'currency', width: 150, calculated: true },
                { field: 'withholding_tax_rate', header: 'WHT Rate', type: 'percentage', width: 100 },
                { field: 'withholding_amount', header: 'WHT Amount', type: 'currency', width: 150, calculated: true },
                { field: 'remarks', header: 'Remarks', type: 'text', width: 250 }
            ],
            non_vat_purchases: [
                { field: 'date', header: 'Date', type: 'date', width: 120 },
                { field: 'invoice_number', header: 'Invoice No.', type: 'text', width: 150 },
                { field: 'invoice_type', header: 'Invoice Type', type: 'text', width: 150 },
                { field: 'mode_of_payment', header: 'Payment Mode', type: 'text', width: 120 },
                { field: 'particulars', header: 'Supplier Name', type: 'text', width: 200 },
                { field: 'address', header: 'Address', type: 'text', width: 200 },
                { field: 'tin', header: 'TIN', type: 'text', width: 150 },
                { field: 'non_vatable_gross_purchases', header: 'Gross Purchases', type: 'currency', width: 150 },
                { field: 'withholding_tax_rate', header: 'WHT Rate', type: 'percentage', width: 100 },
                { field: 'withholding_amount', header: 'WHT Amount', type: 'currency', width: 150, calculated: true },
                { field: 'remarks', header: 'Remarks', type: 'text', width: 250 }
            ],
            vatable_expenses: [
                { field: 'date', header: 'Date', type: 'date', width: 120 },
                { field: 'invoice_number', header: 'Invoice No.', type: 'text', width: 150 },
                { field: 'invoice_type', header: 'Invoice Type', type: 'text', width: 150 },
                { field: 'transaction_type', header: 'Transaction Type', type: 'text', width: 150 },
                { field: 'mode_of_payment', header: 'Payment Mode', type: 'text', width: 120 },
                { field: 'particulars', header: 'Supplier Name', type: 'text', width: 200 },
                { field: 'address', header: 'Address', type: 'text', width: 200 },
                { field: 'tin', header: 'TIN', type: 'text', width: 150 },
                { field: 'gross_amount', header: 'Gross Amount', type: 'currency', width: 150 },
                { field: 'nature_of_expense', header: 'Nature of Expense', type: 'text', width: 250 },
                { field: 'net_expenses', header: 'Net Expenses', type: 'currency', width: 150, calculated: true },
                { field: 'input_tax', header: 'Input Tax', type: 'currency', width: 150, calculated: true },
                { field: 'withholding_tax_rate', header: 'WHT Rate', type: 'percentage', width: 100 },
                { field: 'withholding_amount', header: 'WHT Amount', type: 'currency', width: 150, calculated: true },
                { field: 'remarks', header: 'Remarks', type: 'text', width: 250 }
            ],
            non_vat_expenses: [
                { field: 'date', header: 'Date', type: 'date', width: 120 },
                { field: 'invoice_number', header: 'Invoice No.', type: 'text', width: 150 },
                { field: 'invoice_type', header: 'Invoice Type', type: 'text', width: 150 },
                { field: 'transaction_type', header: 'Transaction Type', type: 'text', width: 150 },
                { field: 'mode_of_payment', header: 'Payment Mode', type: 'text', width: 120 },
                { field: 'particulars', header: 'Supplier Name', type: 'text', width: 200 },
                { field: 'address', header: 'Address', type: 'text', width: 200 },
                { field: 'tin', header: 'TIN', type: 'text', width: 150 },
                { field: 'gross_amount', header: 'Gross Amount', type: 'currency', width: 150 },
                { field: 'nature_of_expense', header: 'Nature of Expense', type: 'text', width: 250 },
                { field: 'withholding_tax_rate', header: 'WHT Rate', type: 'percentage', width: 100 },
                { field: 'withholding_amount', header: 'WHT Amount', type: 'currency', width: 150, calculated: true },
                { field: 'remarks', header: 'Remarks', type: 'text', width: 250 }
            ],
            capex: [
                { field: 'date', header: 'Date', type: 'date', width: 120 },
                { field: 'invoice_number', header: 'Invoice No.', type: 'text', width: 150 },
                { field: 'invoice_type', header: 'Invoice Type', type: 'text', width: 150 },
                { field: 'transaction_type', header: 'Transaction Type', type: 'text', width: 150 },
                { field: 'mode_of_payment', header: 'Payment Mode', type: 'text', width: 120 },
                { field: 'particulars', header: 'Supplier Name', type: 'text', width: 200 },
                { field: 'asset_description', header: 'Asset Description', type: 'text', width: 250 },
                { field: 'address', header: 'Address', type: 'text', width: 200 },
                { field: 'gross_purchase_1', header: 'Non-VAT Purchase', type: 'currency', width: 150 },
                { field: 'gross_purchase_2', header: 'Vatable Purchase', type: 'currency', width: 150 },
                { field: 'withholding_tax', header: 'Withholding Tax', type: 'currency', width: 150 },
                { field: 'remarks', header: 'Remarks', type: 'text', width: 250 }
            ],
            taxes_licenses: [
                { field: 'date', header: 'Date', type: 'date', width: 120 },
                { field: 'reference_number', header: 'Reference No.', type: 'text', width: 150 },
                { field: 'tax_type', header: 'Tax Type', type: 'text', width: 150 },
                { field: 'mode_of_payment', header: 'Payment Mode', type: 'text', width: 120 },
                { field: 'government_agency', header: 'Government Agency', type: 'text', width: 200 },
                { field: 'amount', header: 'Amount', type: 'currency', width: 150 },
                { field: 'remarks', header: 'Remarks', type: 'text', width: 250 }
            ],
            purchase_returns: [
                { field: 'return_date', header: 'Return Date', type: 'date', width: 120 },
                { field: 'return_number', header: 'Return No.', type: 'text', width: 150 },
                { field: 'invoice_number', header: 'Invoice No.', type: 'text', width: 150 },
                { field: 'mode_of_return', header: 'Mode of Return', type: 'text', width: 150 },
                { field: 'gross_purchase_returns', header: 'Gross Return', type: 'currency', width: 150 },
                { field: 'net_purchase_return', header: 'Net Return', type: 'currency', width: 150, calculated: true },
                { field: 'input_tax_return', header: 'Input Tax Return', type: 'currency', width: 150, calculated: true },
                { field: 'remarks', header: 'Remarks', type: 'text', width: 250 }
            ]
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeTabs();
            loadData();
            setupEventListeners();
            startAutoRefresh();
        });

        function initializeTabs() {
            const tabsContainer = document.getElementById('sheetTabs');
            const tabs = [
                { id: 'all', label: 'üìä All Data', type: 'all' },
                { id: 'vatable_sales', label: 'üí∞ Vatable Sales', type: 'vatable_sales' },
                { id: 'non_vat_sales', label: 'üíµ Non-VAT Sales', type: 'non_vat_sales' },
                { id: 'vatable_purchases', label: 'üõí Vatable Purchases', type: 'vatable_purchases' },
                { id: 'non_vat_purchases', label: 'üì¶ Non-VAT Purchases', type: 'non_vat_purchases' },
                { id: 'vatable_expenses', label: 'üíº Vatable Expenses', type: 'vatable_expenses' },
                { id: 'non_vat_expenses', label: 'üìã Non-VAT Expenses', type: 'non_vat_expenses' },
                { id: 'capex', label: 'üèóÔ∏è CAPEX', type: 'capex' },
                { id: 'taxes_licenses', label: 'üèõÔ∏è Taxes & Licenses', type: 'taxes_licenses' },
                { id: 'purchase_returns', label: '‚Ü©Ô∏è Purchase Returns', type: 'purchase_returns' }
            ];

            tabs.forEach(tab => {
                const button = document.createElement('button');
                button.className = 'sheet-tab';
                button.id = `tab-${tab.id}`;
                button.textContent = tab.label;
                button.onclick = () => switchView(tab.type);
                tabsContainer.appendChild(button);
            });

            // Activate first tab
            document.getElementById('tab-all').classList.add('active');
        }

        async function loadData() {
            try {
                // In a real application, this would fetch from your PHP API
                // For now, we'll use localStorage or simulate data
                
                // Check if we have sample data in localStorage
                const savedData = localStorage.getItem('vatEncoderData');
                
                if (savedData) {
                    allData = JSON.parse(savedData);
                } else {
                    // Generate sample data for demonstration
                    allData = generateSampleData();
                    localStorage.setItem('vatEncoderData', JSON.stringify(allData));
                }
                
                applyFilters();
                updateDisplay();
                
            } catch (error) {
                console.error('Error loading data:', error);
                showNotification('Error loading data. Using sample data instead.', 'error');
                
                // Fallback to sample data
                allData = generateSampleData();
                applyFilters();
                updateDisplay();
            }
        }

        function generateSampleData() {
            const sampleData = [];
            const formTypes = Object.keys(formColumns);
            const startDate = new Date(2024, 0, 1);
            
            for (let i = 0; i < 50; i++) {
                const formType = formTypes[Math.floor(Math.random() * formTypes.length)];
                const date = new Date(startDate);
                date.setDate(date.getDate() + Math.floor(Math.random() * 365));
                
                const baseData = {
                    id: `sample-${i}`,
                    type: formType,
                    user_id: 'demo-user',
                    timestamp: date.toISOString(),
                    data: {}
                };
                
                // Generate form-specific data
                const columns = formColumns[formType];
                columns.forEach(col => {
                    if (col.field !== 'id' && col.field !== 'type') {
                        baseData.data[col.field] = generateSampleValue(col);
                    }
                });
                
                // Add calculated fields if missing
                if (formType.includes('vatable') && !baseData.data.net_sales) {
                    const gross = parseFloat(baseData.data.gross_sales || baseData.data.gross_amount || 0);
                    baseData.data.net_sales = (gross / 1.12).toFixed(2);
                    baseData.data.output_tax = (gross / 1.12 * 0.12).toFixed(2);
                }
                
                sampleData.push(baseData);
            }
            
            return sampleData;
        }

        function generateSampleValue(column) {
            switch(column.type) {
                case 'date':
                    const date = new Date();
                    date.setDate(date.getDate() - Math.floor(Math.random() * 90));
                    return date.toISOString().split('T')[0];
                    
                case 'currency':
                    return (Math.random() * 100000).toFixed(2);
                    
                case 'percentage':
                    const rates = ['0%', '1%', '2%', '5%'];
                    return rates[Math.floor(Math.random() * rates.length)];
                    
                case 'text':
                    if (column.field.includes('name')) {
                        const names = ['ABC Corporation', 'XYZ Suppliers', 'John Doe Trading', 'Global Enterprises', 'Local Merchants'];
                        return names[Math.floor(Math.random() * names.length)];
                    } else if (column.field.includes('type')) {
                        const types = ['Cash', 'Charge', 'Service', 'SI', 'OR', 'DR'];
                        return types[Math.floor(Math.random() * types.length)];
                    } else if (column.field === 'tin') {
                        return '123-456-789-000';
                    }
                    return 'Sample Data';
                    
                default:
                    return 'N/A';
            }
        }

        function switchView(viewType) {
            currentView = viewType;
            
            // Update active tab
            document.querySelectorAll('.sheet-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(`tab-${viewType}`).classList.add('active');
            
            applyFilters();
            updateDisplay();
        }

        function applyFilters() {
            let filtered = allData;
            
            // Filter by view type
            if (currentView !== 'all') {
                filtered = filtered.filter(item => item.type === currentView);
            }
            
            // Filter by date range
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            
            if (dateFrom) {
                filtered = filtered.filter(item => {
                    const itemDate = new Date(item.data.date || item.timestamp);
                    const fromDate = new Date(dateFrom);
                    return itemDate >= fromDate;
                });
            }
            
            if (dateTo) {
                filtered = filtered.filter(item => {
                    const itemDate = new Date(item.data.date || item.timestamp);
                    const toDate = new Date(dateTo);
                    toDate.setHours(23, 59, 59, 999);
                    return itemDate <= toDate;
                });
            }
            
            // Filter by form type (from dropdown)
            const formFilter = document.getElementById('formTypeFilter').value;
            if (formFilter) {
                filtered = filtered.filter(item => item.type === formFilter);
            }
            
            // Filter by search text
            const searchText = document.getElementById('globalSearch').value.toLowerCase();
            if (searchText) {
                filtered = filtered.filter(item => {
                    return Object.values(item.data).some(value => 
                        String(value).toLowerCase().includes(searchText)
                    ) || item.type.toLowerCase().includes(searchText);
                });
            }
            
            filteredData = filtered;
            updateFilterTags();
        }

        function updateDisplay() {
            const grid = document.getElementById('excelGrid');
            const noDataMessage = document.getElementById('noDataMessage');
            
            if (filteredData.length === 0) {
                noDataMessage.style.display = 'block';
                grid.innerHTML = '';
                grid.appendChild(noDataMessage);
                updateTotals();
                return;
            }
            
            noDataMessage.style.display = 'none';
            
            // Get appropriate columns for current view
            let columns = [];
            if (currentView === 'all') {
                // For "All Data" view, show common columns
                columns = [
                    { field: 'type', header: 'Form Type', type: 'text', width: 150 },
                    { field: 'date', header: 'Date', type: 'date', width: 120 },
                    { field: 'invoice_number', header: 'Reference No.', type: 'text', width: 150 },
                    { field: 'particulars', header: 'Name', type: 'text', width: 200 },
                    { field: 'tin', header: 'TIN', type: 'text', width: 150 },
                    { field: 'amount', header: 'Amount', type: 'currency', width: 150 },
                    { field: 'vat', header: 'VAT', type: 'currency', width: 150 },
                    { field: 'withholding_amount', header: 'WHT', type: 'currency', width: 150 },
                    { field: 'remarks', header: 'Remarks', type: 'text', width: 200 }
                ];
            } else {
                columns = formColumns[currentView];
            }
            
            // Build the grid
            grid.innerHTML = '';
            
            // Create header
            const header = document.createElement('div');
            header.className = 'grid-header';
            
            // Add row number column
            const rowNumHeader = document.createElement('div');
            rowNumHeader.className = 'header-cell';
            rowNumHeader.textContent = '#';
            rowNumHeader.style.width = '60px';
            header.appendChild(rowNumHeader);
            
            // Add data columns
            columns.forEach(col => {
                const headerCell = document.createElement('div');
                headerCell.className = 'header-cell';
                headerCell.textContent = col.header;
                headerCell.style.width = `${col.width}px`;
                headerCell.style.minWidth = `${col.width}px`;
                headerCell.title = col.header;
                header.appendChild(headerCell);
            });
            
            grid.appendChild(header);
            
            // Create body
            const body = document.createElement('div');
            body.className = 'grid-body';
            
            filteredData.forEach((item, index) => {
                const row = document.createElement('div');
                row.className = 'grid-row';
                row.dataset.id = item.id;
                
                // Row selection checkbox
                row.onclick = (e) => {
                    if (e.target.type !== 'checkbox') {
                        toggleRowSelection(item.id);
                    }
                };
                
                // Row number cell
                const rowNumCell = document.createElement('div');
                rowNumCell.className = 'row-number';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = selectedRows.has(item.id);
                checkbox.onclick = (e) => {
                    e.stopPropagation();
                    toggleRowSelection(item.id);
                };
                
                rowNumCell.appendChild(checkbox);
                rowNumCell.appendChild(document.createTextNode(` ${index + 1}`));
                row.appendChild(rowNumCell);
                
                // Data cells
                columns.forEach(col => {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    
                    let value = '';
                    if (currentView === 'all') {
                        // For "All Data" view, extract appropriate value
                        value = extractValueForAllView(item, col.field);
                    } else {
                        value = item.data[col.field] || '';
                    }
                    
                    // Format the value based on type
                    cell.textContent = formatValue(value, col.type);
                    cell.className = `grid-cell ${col.type} ${col.calculated ? 'calculated' : ''}`;
                    cell.style.width = `${col.width}px`;
                    cell.style.minWidth = `${col.width}px`;
                    cell.title = value;
                    
                    row.appendChild(cell);
                });
                
                body.appendChild(row);
            });
            
            grid.appendChild(body);
            updateTotals();
        }

        function extractValueForAllView(item, field) {
            switch(field) {
                case 'type':
                    return formatFormType(item.type);
                case 'date':
                    return item.data.date || item.timestamp.split('T')[0];
                case 'invoice_number':
                    return item.data.invoice_number || item.data.reference_number || 'N/A';
                case 'particulars':
                    return item.data.particulars || 'N/A';
                case 'tin':
                    return item.data.tin ? formatTIN(item.data.tin) : 'N/A';
                case 'amount':
                    return item.data.gross_sales || item.data.gross_amount || item.data.amount || '0.00';
                case 'vat':
                    return item.data.output_tax || item.data.input_tax || '0.00';
                case 'withholding_amount':
                    return item.data.withholding_amount || '0.00';
                case 'remarks':
                    return item.data.remarks || '';
                default:
                    return '';
            }
        }

        function formatValue(value, type) {
            if (value === null || value === undefined) return '';
            
            switch(type) {
                case 'currency':
                    return `‚Ç±${parseFloat(value).toLocaleString('en-PH', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    })}`;
                    
                case 'date':
                    if (!value) return '';
                    const date = new Date(value);
                    return date.toLocaleDateString('en-PH');
                    
                case 'percentage':
                    return value;
                    
                case 'text':
                    return String(value);
                    
                default:
                    return String(value);
            }
        }

        function formatFormType(type) {
            const formNames = {
                'vatable_sales': 'Vatable Sales',
                'non_vat_sales': 'Non-VAT Sales',
                'vatable_purchases': 'Vatable Purchases',
                'non_vat_purchases': 'Non-VAT Purchases',
                'vatable_expenses': 'Vatable Expenses',
                'non_vat_expenses': 'Non-VAT Expenses',
                'capex': 'CAPEX',
                'taxes_licenses': 'Taxes & Licenses',
                'purchase_returns': 'Purchase Returns'
            };
            return formNames[type] || type;
        }

        function formatTIN(tin) {
            if (!tin) return '';
            const cleaned = tin.replace(/\D/g, '');
            if (cleaned.length === 12) {
                return cleaned.replace(/(\d{3})(\d{3})(\d{3})(\d{3})/, '$1-$2-$3-$4');
            }
            return tin;
        }

        function updateTotals() {
            const totalRecords = filteredData.length;
            const totalAmount = filteredData.reduce((sum, item) => {
                const amount = parseFloat(item.data.gross_sales || item.data.gross_amount || item.data.amount || 0);
                return sum + amount;
            }, 0);
            
            const totalVAT = filteredData.reduce((sum, item) => {
                const vat = parseFloat(item.data.output_tax || item.data.input_tax || 0);
                return sum + vat;
            }, 0);
            
            const totalWithholding = filteredData.reduce((sum, item) => {
                const wht = parseFloat(item.data.withholding_amount || 0);
                return sum + wht;
            }, 0);
            
            document.getElementById('totalRecordsCount').textContent = totalRecords.toLocaleString();
            document.getElementById('totalAmount').textContent = `‚Ç±${totalAmount.toLocaleString('en-PH', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            })}`;
            document.getElementById('totalVAT').textContent = `‚Ç±${totalVAT.toLocaleString('en-PH', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            })}`;
            document.getElementById('totalWithholding').textContent = `‚Ç±${totalWithholding.toLocaleString('en-PH', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            })}`;
            document.getElementById('totalRecords').textContent = `${totalRecords} records`;
            document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
        }

        function updateFilterTags() {
            const filterTags = document.getElementById('activeFilters');
            filterTags.innerHTML = '';
            
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const formFilter = document.getElementById('formTypeFilter').value;
            const searchText = document.getElementById('globalSearch').value;
            
            if (currentView !== 'all') {
                addFilterTag(`View: ${formatFormType(currentView)}`, () => {
                    switchView('all');
                });
            }
            
            if (dateFrom) {
                addFilterTag(`From: ${dateFrom}`, () => {
                    document.getElementById('dateFrom').value = '';
                    applyFilters();
                    updateDisplay();
                });
            }
            
            if (dateTo) {
                addFilterTag(`To: ${dateTo}`, () => {
                    document.getElementById('dateTo').value = '';
                    applyFilters();
                    updateDisplay();
                });
            }
            
            if (formFilter) {
                addFilterTag(`Form: ${formatFormType(formFilter)}`, () => {
                    document.getElementById('formTypeFilter').value = '';
                    applyFilters();
                    updateDisplay();
                });
            }
            
            if (searchText) {
                addFilterTag(`Search: "${searchText}"`, () => {
                    document.getElementById('globalSearch').value = '';
                    applyFilters();
                    updateDisplay();
                });
            }
        }

        function addFilterTag(label, removeCallback) {
            const tag = document.createElement('div');
            tag.className = 'filter-tag';
            tag.innerHTML = `${label} <span class="remove" onclick="${removeCallback}">√ó</span>`;
            
            // Fix the onclick handler
            const removeSpan = tag.querySelector('.remove');
            removeSpan.onclick = removeCallback;
            
            document.getElementById('activeFilters').appendChild(tag);
        }

        function setupEventListeners() {
            // Search input
            document.getElementById('globalSearch').addEventListener('input', debounce(() => {
                applyFilters();
                updateDisplay();
            }, 300));
            
            // Date filters
            document.getElementById('dateFrom').addEventListener('change', () => {
                applyFilters();
                updateDisplay();
            });
            
            document.getElementById('dateTo').addEventListener('change', () => {
                applyFilters();
                updateDisplay();
            });
            
            // Form type filter
            document.getElementById('formTypeFilter').addEventListener('change', () => {
                applyFilters();
                updateDisplay();
            });
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function toggleRowSelection(rowId) {
            if (selectedRows.has(rowId)) {
                selectedRows.delete(rowId);
            } else {
                selectedRows.add(rowId);
            }
            
            // Update checkbox state
            const row = document.querySelector(`.grid-row[data-id="${rowId}"]`);
            if (row) {
                const checkbox = row.querySelector('input[type="checkbox"]');
                if (checkbox) {
                    checkbox.checked = selectedRows.has(rowId);
                }
            }
        }

        function deleteSelected() {
            if (selectedRows.size === 0) {
                showNotification('Please select rows to delete', 'warning');
                return;
            }
            
            if (confirm(`Are you sure you want to delete ${selectedRows.size} record(s)?`)) {
                // In a real application, this would call your API to delete records
                allData = allData.filter(item => !selectedRows.has(item.id));
                selectedRows.clear();
                
                // Save to localStorage
                localStorage.setItem('vatEncoderData', JSON.stringify(allData));
                
                applyFilters();
                updateDisplay();
                showNotification(`${selectedRows.size} record(s) deleted successfully`, 'success');
            }
        }

        function refreshData() {
            // In a real application, this would fetch fresh data from the server
            loadData();
            showNotification('Data refreshed successfully', 'success');
        }

        function clearFilters() {
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('formTypeFilter').value = '';
            document.getElementById('globalSearch').value = '';
            
            applyFilters();
            updateDisplay();
            showNotification('All filters cleared', 'info');
        }

        function exportToCSV() {
            if (filteredData.length === 0) {
                showNotification('No data to export', 'warning');
                return;
            }
            
            let csvContent = '';
            
            // Get headers
            let headers = [];
            if (currentView === 'all') {
                headers = ['Form Type', 'Date', 'Reference No.', 'Name', 'TIN', 'Amount', 'VAT', 'WHT', 'Remarks'];
            } else {
                headers = formColumns[currentView].map(col => col.header);
            }
            
            csvContent += headers.join(',') + '\n';
            
            // Add rows
            filteredData.forEach(item => {
                let row = [];
                
                if (currentView === 'all') {
                    row = [
                        formatFormType(item.type),
                        item.data.date || item.timestamp.split('T')[0],
                        item.data.invoice_number || item.data.reference_number || '',
                        item.data.particulars || '',
                        item.data.tin ? formatTIN(item.data.tin) : '',
                        item.data.gross_sales || item.data.gross_amount || item.data.amount || '',
                        item.data.output_tax || item.data.input_tax || '',
                        item.data.withholding_amount || '',
                        item.data.remarks || ''
                    ];
                } else {
                    formColumns[currentView].forEach(col => {
                        row.push(item.data[col.field] || '');
                    });
                }
                
                // Escape commas and quotes
                row = row.map(field => {
                    const str = String(field);
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return `"${str.replace(/"/g, '""')}"`;
                    }
                    return str;
                });
                
                csvContent += row.join(',') + '\n';
            });
            
            // Download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `vat_data_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('CSV file exported successfully', 'success');
        }

        function exportToExcel() {
            // For simplicity, we'll use CSV export
            // In a real application, you might use a library like SheetJS
            exportToCSV();
        }

        function printView() {
            window.print();
        }

        function startAutoRefresh() {
            // Auto-refresh every 30 seconds
            setInterval(() => {
                // In a real application, check for new data
                const shouldRefresh = localStorage.getItem('vatAutoRefresh') === 'true';
                if (shouldRefresh) {
                    refreshData();
                }
            }, 30000);
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                background: ${type === 'success' ? '#27ae60' : type === 'error' ? '#e74c3c' : '#3498db'};
                color: white;
                border-radius: 4px;
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Add CSS animations for notifications
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
